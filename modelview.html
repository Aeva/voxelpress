<!doctype html>
<html><head><style type="text/css">

body {
    background-color: black;
}

.fragment {
    position: absolute;
    border: blue;
    -moz-box-sizing: border-box;
    border: 1px solid #333;
}


</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript">

var VOX = {
    "data" : {
        "width" : 0,
        "length" : 0,
        "depth" : 0,
        "scale" : [0, 0, 0],
        "scratch" : "",
        "stub" : "",
    },


    "draw" : function (x, y, z) {
        "use strict";
        
        /*
          Draw a voxel.
         */

        var cx = x * VOX.data.scale[0];
        var cy = y * VOX.data.scale[1];
        var cz = z * VOX.data.scale[2];

        var el = VOX.data.stub+"z-index:"+(cz+1)+";";
        el += "left:"+cx+"em;";
        el += "top:"+cy+"em;";
        
        el += "'></div>";
        VOX.data.scratch += el;
    },

    
    "parse" : function (packet) {
        "use strict";
        /*
          This function takes in a javascript object, most likely
          fetched via XHR, and interprets binary data, in a base64
          string, and makes draw calls based on what it finds.
         */

        VOX.data.width = packet.w;
        VOX.data.length = packet.l;
        VOX.data.depth = packet.d;
        VOX.data.scale = packet.s;
        VOX.data.scratch = "";

        var bg_color = 0;
        var bg_increment = function () {
            //closure
            var slice = Math.floor(255/packet.d);
            var result = slice | (slice<<8) | (slice<<16);
            return result & parseInt("FFFFFF", 16);
        }();

        var stub = "<div class='fragment' style='";
        stub += "width:"+packet.s[0]+"em;";
        stub += "height:"+packet.s[1]+"em;";

        var advance_bg = function () {
            bg_color += bg_increment;
            var color_str = bg_color.toString(16);
            while (color_str.length < 6) {
                color_str = "0" + color_str;
            }
            VOX.data.stub = stub + "background-color:#"+color_str+";";
        };

        var size = packet.w * packet.l * packet.d;
        var blob = atob(packet.a);
        if ((size/8) < blob.length) {
            var _byte;
            var period = 1;
            var pointer = 0;
            var masks = [1, 2, 4, 8, 16, 32, 64, 128];
            var x = 0;
            var y = 0;
            var z = 0;
            
            advance_bg();
            for (var i=0; i<size; i+=1) {
                _byte = blob.charCodeAt(pointer);
                if ((_byte & masks[period])!==0) {
                    VOX.draw(x,y,z);
                }
                x +=1;
                if (x >= packet.w) {
                    x = 0;
                    y += 1;
                    if (y >= packet.l) {
                        y = 0;
                        z += 1;
                        advance_bg();
                    }
                }
                period += 1;
                if (period >= 8) {
                    pointer += 1;
                    period = 1;
                }
            }
            document.body.innerHTML = VOX.data.scratch;
        }
        else {
            throw("There is too little binary data.");
        }
    },


    "main" : function() {
        $.getJSON('test.json', VOX.parse);
    },
};


$(document).ready(VOX.main);

</script></head><body>
</body></html>
